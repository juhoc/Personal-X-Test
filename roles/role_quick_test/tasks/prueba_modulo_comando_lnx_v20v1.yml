---
- name: Tareas por bloques - Validacion formato CRQ o ICR
  block:
    - name: Validando Formato de Cambio o Incidente
      assert:
        that:
          - idcrqincreq | string | regex_search('(CRQ|INC|REQ)[0-9]{12}')
        fail_msg: "El CRQ, INC o REQ no cumplen con la condiciones del formato"
        success_msg: "El CRQ, INC o REQ cumplen con las condiciones del formato"
      run_once: true
      delegate_to: localhost

#    - name: Validar usuarios
#      become: true
#      become_user: ccrbao
#      become_method: su
#      become_exe: sudo su -
#      shell: "echo IP: {{ item }}"
#      args:
#        executable: /bin/bash
#      loop: "{{ ip_host }}"
#      loop: "{{ ip_host.split(',') }}"

#    - name: Copiar archivo con scp usando la credencial de AWX
#      become: true
#      become_user: ccrbao
#      become_method: su
#      become_exe: sudo su -
#      shell: |
#        eval $(ssh-agent -s)
#        echo "{{ mi_passphrase }}" | ssh-add /home/ccrbao/.ssh/id_rsa
#        scp -o StrictHostKeyChecking=no ccrbao@{{ hostvars[inventory_hostname].ipaddress }}:/tmp/My_XML_File.xml /tmp
#      loop: "{{ ip_host }}"
#      loop: "{{ ip_host.split(',') }}"
#      args:
#        executable: /bin/bash
#      no_log: true        
#      delegate_to: asitsmaop0.bvm.bluecare.kyndryl.net

    - name: Envio de evidencias por CRQ, INC o REQ
      mail:
        host: "{{ smtp }}"
        port: "{{ smtpport }}"
        from: "{{ mailfrom }}"
        to: "{{ mailto }}"
        subject: "Reportes GDM Linux Patching"
        body: "Se adjuntan todas las evidencias del {{ idcrqincreq }} de previas y posteriores al IPL"
#        attach: "{{ listflzip.stdout_lines }}"
#      register: valmail
#      no_log: true
      delegate_to: asitsmaop0.bvm.bluecare.kyndryl.net
      run_once: true
