- block:
    - set_fact:
        target_hosts: "{{ ansible_play_hosts_all }}"

    - name: Test shell
      become: true
      shell: echo "./busca_v -vmName {{ iten.split('.')[0] }} Thin" > /tmp/info_vm_{{ iten.split('.')[0] }}_$({{ asbtime }})
      loop: "{{ target_hosts }}"
      loop_control:
        loop_var: iten
  
    - name: Write log
      become: true
      shell: cat /tmp/info_vm_"{{ item.split('.')[0] }}_$(date +%y%m%d)" | grep Thin
      loop: "{{ target_hosts }}"
      loop_control:
        loop_var: item
      register: asbhoslogs

    - name: Reporte
      assert:
        that:
          - asbhoslogs.failed_when_result is not defined
        fail_msg: "KO Palabra clave no esta en - {{ item.split('.')[0] }}"
        success_msg: "OK Palabra clave esta en - {{ item.split('.')[0] }}"
      loop: "{{ target_hosts }}"
      loop_control:
        loop_var: item
  delegate_to: lvpapansiblmx02.bvm.bluecare.kyndryl.net
  run_once: true
